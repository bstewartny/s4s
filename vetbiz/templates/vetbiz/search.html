<!DOCTYPE html>
<html>
    <head>
        <title>Stars4Stripes</title>
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <style type="text/css">
        body{padding-top:60px;max-height:100%;overflow:hidden}
        .container-fluid{padding-right:0px;} 
        .row-fluid{padding-right:0px;background-color:lightgray;} 
        .scrollable{overflow-y:scroll;height:800px}
        .sidebar-nav{background-color:lightgray}
        .sidebar-place{min-height:110px;vertical-align:top;background-color:white;padding:10px;margin:10px;
            -moz-box-shadow: 4px 4px 2px #888;
            -webkit-box-shadow: 4px 4px 2px #888;
            box-shadow: 4px 4px 2px #888;
        }
        #map-canvas { height:800px;padding:0;margin:0;padding-right:0px }
        #map-canvas img { 
          max-width: none;
      }
      #sidebar{background-color:lightgray;}
       media="screen" #map-canvas label { 
            width: auto; display:inline; 
        }
        /** FIX for Bootstrap and Google Maps Info window styes problem **/}
        img[src*="gstatic.com/"], img[src*="googleapis.com/"] {
            max-width: none;
        }
    </style>

    <link type="text/css" href="/static/css/bootstrap.min.css" rel="stylesheet" />
    <link type="text/css" href="/static/css/bootstrap-responsive.min.css" rel="stylesheet"  />
    <script type="text/javascript" src="/static/js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTZYjwE2l-IodYDfJRZkk5Xlu4u2dMbVQ&sensor=true"></script>
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=true"></script>

    <script type="text/javascript">


        function getUserLocation(fn){
            if(navigator.geolocation)
            {
                navigator.geolocation.getCurrentPosition(function(position){
                       fn(new google.maps.LatLng(position.coords.latitude,position.coords.longitude)); 
                        });
            }
            else
            {
                fn(new google.maps.LatLng(-34.397, 150.644));
            }
        }

        function setUserPosition(position){
            map.setCenter(new google.maps.LatLng(position.coords.latitude,position.coords.longitude));
        }

        function initialize() {
            getUserLocation(createMap);
        }

        var RADIUS=5000;
        var map=null;
        var places={};
        var markers=[];

        function createMap(center)
        {  
            map = new google.maps.Map(document.getElementById("map-canvas"),
                    {
                        center:center,
                        panControl:true,
                        zoomControl:true,
                        zoom: 14,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    });
/*
            $(window).resize(function () {
                var h = $(window).height(),
                    offsetTop = 40; // Calculate the top offset
                $('#map-canvas').css('height', (h - offsetTop));
                }).resize();
*/
            getNearbyBusinesses(center,RADIUS,false);
        }

        function getNearbyBusinesses(center,radius,veteran_only)
        {
            if(veteran_only)
            {
                // just get from our database         
                getNearbyVeteranBusinesses(center,radius);
            }
            else
            {
                // first get google places, then augment with data from our system

                getNearbyPlaces(center,radius);
            }
        }

        function addPlace(key,place)
        {
            console.log('addPlace: '+key+', '+place['name']);
        
            for(var k in places)
            {
                p=places[k];
                if(samePlace(p,place))
                {
                    console.log('found same place, merging...');
                    p=mergePlace(p,place);
                    places[k]=p
                    return p;
                }
            }
            places[key]=place;
            return place;
        }

        function samePlace(a,b)
        {
            return (a['name']==b['name']);
        }

        function mergePlace(a,b)
        {
            console.log("merging place: "+a['name'] +" is same as "+b['name']);

            console.log('object a:');
            for(var k in a)
            {
                console.log(k+"="+a[k]);
            }
            console.log('object b:');
            for(var k in b)
            {
                console.log(k+"="+b[k]);
            }
            if(a['veteran_discounts']==true)
                b['veteran_discounts']=true;

            if(a['veteran_owned']==true)
                b['veteran_owned']=true;
            
            if(b['veteran_discounts']==true)
                a['veteran_discounts']=true;

            if(b['veteran_owned']==true)
                a['veteran_owned']=true;

            a['offers']=b['offers'];
            console.log('merged object:');
            for(var k in a)
            {
                console.log(k+"="+a[k]);
            }


            return a;
            //return $.extend(a,b); 
        
        }

        function getNearbyPlaces(center,radius)
        {
            clearMarkers();

            var request={
                location:center,
                radius:radius,
                types:['store']
            };



            service=new google.maps.places.PlacesService(map);
            service.nearbySearch(request,function (results,status){
                                        if(status==google.maps.places.PlacesServiceStatus.OK)
                                        {
                                            console.log('got '+results.length+' places from google api');
                                            for(var i=0;i<results.length;i++)
                                            {
                                                var place=results[i];
                                                addPlace(place.id,googlePlaceToBusinessObject(place));
                                            }
                                        }

                                        // now get veteran owned businesses
                                        $.ajax(
                                            {
                                                type:'GET',
                                                url:'/vetbiz/api/searchbiz/',
                                                dataType:'json',
                                                data:{
                                                    lat:center.lat(),
                                                    lon:center.lng(),
                                                    radius:radius},
                                                success:function(results){
                                                    console.log('got '+results.length+' places from current API');
                                                    offers=[];
                                                    for(var i=0;i<results.length;i++)
                                                    {
                                                        var biz=results[i];
                                                        if(biz['model']=='vetbiz.offer')
                                                        {
                                                            offers.push(biz);
                                                        }
                                                    }
                                                    for(var i=0;i<results.length;i++)
                                                    {
                                                        var biz=results[i];
                                                        if(biz['model']=='vetbiz.business')
                                                        {
                                                            var obj=biz['fields'];
                                                            obj['key']=biz['pk'];
                                                            obj['offers']=[];
                                                            for(var j=0;j<offers.length;j++)
                                                            {
                                                                var offer=offers[j];
                                                                if(offer['fields']['business']==biz['pk']){
                                                                    obj['offers'].push(offer);
                                                                }
                                                            }
                                                            addPlace(obj['key'],obj);
                                                        }
                                                    }
                                                    
                                                    // add markers for all the places
                                                    createMarkers();
                                                }
                                            }        
                                            );
                                        });
        }
        
        function googlePlaceToBusinessObject(place)
        {
            return {
                'name':place.name,
                'key':place.id,
                'veteran_discounts':false,
                'veteran_owned':false,
                'lat':place.geometry.location.lat(),
                'lon':place.geometry.location.lng(),
                'address':place.vicinity,
                'phone':place.formatted_phone_number,
                'icon':place.icon,
                'types':places.types
            };
        }

        function getNearbyVeteranBusinesses(center,radius)
        {
            clearMarkers();
            $.ajax(
                {
                    type:'GET',
                    url:'/vetbiz/api/searchbiz/',
                    dataType:'json',
                    data:{
                        lat:center.lat(),
                        lon:center.lng(),
                        radius:radius},
                    success:function(results){
                        for(var i=0;i<results.length;i++)
                        {
                            var biz=results[i];
                            var obj=biz['fields'];
                            obj['key']=biz['pk'];
                            addPlace(obj['key'],obj);
                        }
                        createMarkers();
                    }
                }        
                );

        }

        function searchVeteranOwned()
        {
            getUserLocation(function(center){
                    getNearbyBusinesses(center,RADIUS,true);
            });
        }

        function searchVeteranDiscounts()
        {
            getUserLocation(function(center){
                    getNearbyBusinesses(center,RADIUS,true);
            });
        }

        function searchAll(){
            getUserLocation(function(center){
                    getNearbyBusinesses(center,RADIUS,false);
            });
        }

        function clearMarkers(){
            $('#sidebar').html('');
            for(var i=0;i<markers.length;i++){
                markers[i].setMap(null);
            }
            markers=[];
        }


        function setVeteranOwned(id,input){
            place=places[id];
            place['veteran_owned']=true;
            updateBusiness(place);
        }

        function setVeteranDiscounts(id,input){
            place=places[id];
            place['veteran_discounts']=true;
            updateBusiness(place);
        }
    
        function updateBusiness(place){
            $.ajax(
                {
                    type:'POST',
                    url:'/vetbiz/api/updatebiz/',
                    data:place
                }        
                ).done(function(msg){ });
        }

        function createInfoWindow(biz){
            var content="<div><b>"+biz['name']+"</b><br><br>"+
                "<input type='checkbox' onclick='setVeteranOwned(\""+biz['key']+"\",this);'>Veteran Owned<br>"+
                "<input type='checkbox' onclick='setVeteranDiscounts(\""+biz['key']+"\",this);'>Veteran Discounts</div>";
            return new google.maps.InfoWindow({content:content}); 
        }

        function createMarkers(){
            console.log('create markers');

            for(var key in places){
                createMarker(places[key]);
            }
        }

        function createMarker(biz){
            console.log('create marker: '+biz['name']);
            var icon='http://maps.google.com/mapfiles/ms/icons/green-dot.png';
            var veteran_owned=biz['veteran_owned'];
            var veteran_discounts=biz['veteran_discounts'];
            if (veteran_owned || veteran_discounts)
            {
                if (veteran_owned && veteran_discounts)
                {
                    // purple marker
                    icon='http://maps.google.com/mapfiles/ms/icons/purple-dot.png';
                }
                else
                {
                    if(veteran_owned)
                    {
                        // blue marker 
                        icon='http://maps.google.com/mapfiles/ms/icons/blue-dot.png';
                    }
                    if(veteran_discounts)
                    {
                        // red marker 
                        icon='http://maps.google.com/mapfiles/ms/icons/red-dot.png';
                    }
                }
            }            
            
            var marker=new google.maps.Marker({
                        map:map,
                        icon:icon,
                        position:new google.maps.LatLng(biz['lat'],biz['lon']),
                        title:biz['name']
                        });
            
            markers.push(marker);
            
            createSideBarItem(biz);

            // TODO: show info on hover, and make sidebar scroll entry to the top and highlight on click...
            google.maps.event.addListener(marker,'click',function(){
                        createInfoWindow(biz).open(map,marker);
                    });
        }

        function createSideBarItem(place)
        {
            // create side bar nav box for this biz
            var div=$('<div>').addClass('sidebar-place').addClass('muted');

            div.append($('<b>').html(place['name']));
            div.append($('<br>'));
            div.append($('<p>').html(place['address']));
                
            if(place['veteran_owned'])
            {
                div.append($('<span>').addClass('label').addClass('label-info').css('margin-right',4).html('Veteran Owned'));        
            }
            if(place['veteran_discounts'])
            {
                div.append($('<span>').addClass('label').addClass('label-success').html('Veteran Discounts'));        
            }
            if(place['offers'])
            {
                if(place['offers'].length>0)
                {
                    div.append($('<br>'));
                    div.append($('<p>').html(place['offers']['0']['fields']['title']));
                }
            }
            div.appendTo("#sidebar");
        }

        google.maps.event.addDomListener(window, 'load', initialize);

    </script>
</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
          <div class="container-fluid">
                <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="brand" href="#"><b>S</b>tars<i>4</i><b>S</b>tripes</a>
                <div class="nav-collapse collapse">

                    <p class="navbar-text pull-right">
                    <button class="btn btn-primary">Log In</button>
                    <button class="btn btn-success">Sign Up</button>
                    </p>
                    <form method="get" action="" style="padding-top:10px" class="form-inline">
                          <div class="input-append">
                    <div class="btn-group">
                    <button class="btn btn-info dropdown-toggle" data-toggle="dropdown">Features<span class="caret"></span></button>
                        <ul class="dropdown-menu">
                            <li><a href="javascript:searchVeteranOwned();">Veteran Owned Businesses</a></li>
                            <li><a href="javascript:searchVeteranDiscounts();">Discounts for Veterans</a></li>
                            <li><a href="javascript:searchOffers();">Offers and Deals</a></li>
                        </ul>
                    </div>
                        <input id="q" size="200" style="width:400px" name="q" value="{{query}}" type="text"  placeholder="Find veteran businesses...">
                        <div class="btn-group">
                            <button class="btn dropdown-toggle btn-warning" data-toggle="dropdown"><span class="caret"></span></button>
                            <ul class="dropdown-menu">
                                <li><a href="javascript:searchVeteranOwned();">Find Veteran Owned Businesses</a></li>
                                <li><a href="javascript:searchVeteranDiscounts();">Find Businesses with Veteran Discounts</a></li>
                                <li><a href="javascript:searchAll();">Search All Businesses...</a></li>
                            </ul>
                        </div>
                        <button class="btn btn-warning" type="submit">Search</button>
                    </div>
                    </form>
                </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>
    <div class="container-fluid" style="padding-right:0px;padding-left:0px"> 
        <div class="row-fluid" style="padding-right:0px">
            <div class="span3">
                <div class="sidebar-nav scrollable" id="sidebar"></div> 
            </div>
            <div class="span9" style="margin:0;padding:0;padding-right:0px">
                <div id="map-canvas" style="padding-right:0px"></div>
            </div>
        </div>
    </div>
  </body>
</html>

